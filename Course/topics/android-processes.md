# Процессы

## Что такое **процесс**

это изолированная среда выполнения, предоставляемая операционной системой. Характеризуется:

- набором инструкций для выполнения (программный код)
- контекстом выполнения (текущее состояние регистров CPU, счетчика команд и стека исполнения)
- пространством памяти (доступное процессу изолированное от прочих процессов виртуальное пространство адресов памяти)

В Андроиде стандартно каждое приложение запускается в собственном процессе. Изоляция процессов - ответственность Linux
ядра Андроид. Благодаря ей достигается закрытость и безопасность процесса исполнения приложений от воздействия извне.

## Свойства процесса

1. Идентификатор (Process ID - PID)
    - уникальный идентификатор, выданный системой при создании
    - используется для управления процессом со стороны системы и указания на него
2. Идентификаторы Пользователя и Группы пользователей (User ID & Group ID - UID & GID)
    - процесс запускается от лица определенного пользователя и группы пользователей, которые обладают определенными
      правами и ограничениями
    - в Андроиде каждое приложение является отдельным пользователем
3. Виртуальное пространство памяти
    - каждый процесс работает с собственным изолированным пространством адресов памяти
    - защищает выделенную процессу память от вмешательства извне
4. Потоки выполнения
    - процесс может иметь множество потоков
    - процесс имеет **главный поток (Main Thread)**, который отвечает за основную задачу процесса. В случае большинства
      приложений - это поток, который выполняет задачу интеракций с пользователем программы
    - прочие потоки называются **рабочими потоками (Worker Threads)**, и служат для разгрузки **главного потока** от
      интенсивных или просто длительных операций работы с данными
5. Состояние процесса
    - **Выполняется (Running)**: активно исполняет заданные инструкции
    - **Готов (Ready)**: подготовлен к выполнению и ожидает выделения процессорного времени
    - **Заблокирован (Blocked)**: ожидает события или доступа к ресурсу
    - **Прекращен (Terminated)**: завершил выполнение или прерван системой
6. Приоритет и Распределение процесса
    - имеет приоритетный уровень, определяющий распределение центральным процессором
    - Андроид присваивает приоритет, основываясь на важности процесса для пользовательского опыта
7. Ресурсы и Хендлы
    - права доступа к системным ресурсам (файлам, сетевым сокетам и прочим устройствам)
    - управляется с помощью дескрипторов файлов и хендлов внутри процесса
8. IPC

## Процессы в Андроиде

В Линукс при запуске системы ядро инициирует основной процесс с id равным 1. Остальные процессы являются дочерними и
создаются при помощи одной из двух команд: `exec()` и `fork()`.

`exec()` заменяет предыдущий экземпляр процесса, при этом наследуя все его данные и ресурсы
`fork()` копирует родительский процесс, но присваивает новый идентификатор, а так же привязывает дочерний процесс к
родительскому по идентификатору родителя

Процессы в Андроиде создаются командой `fork()` от процесса **Zygote**, в который уже подключены все системные
библиотеки и ресурсы, необходимые для работы приложения.

<img src="Android_processes1.png" alt=""/>

Каждое приложение запускается в собственном процессе и уникальным пользователем (регистрируется для приложения), с
соответствующим имени пакета приложения именем.

Но есть возможность запустить несколько приложений в одном процессе,
если прописать в манифестах один `android:sharedUserId="your_shared_applications_process_id"` и имя
процесса `android:process="com.shared.process.name.example"` для блока `application`.

> Однако такой способ был объявлен устаревшим, и Google рекомендует пользоваться механизмами межпроцессного
> взаимодействия (IPC) c API 29
> {style="warning"}

Кроме того есть возможность запускать каждый Андроид компонент в дочернем процессе. Для этого у
компонента (`reciever`, `activity`, `provider`, `service`) нужно указать свойство `android:process=:child_N`.

> Стоит помнить, что каждый процесс - это изолированная среда исполнения приложения. Как следствие это может привести
> к ошибкам доступа к ресурсам, например с доступом к БД и memory cache. Кроме того, объект класса Application будет
> инициализирован отдельно для каждого процесса, что приведет к полной изоляции DI графов
> {style="warning"}